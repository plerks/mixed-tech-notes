# 关于TCP建立连接时的三次握手和关闭连接时的四次握手

## 建立连接
建立连接时设计为三次握手应该是为了双方都能确认信道畅通。三次握手之后，双方都向对方发送了数据，也收到过对方的答复，从而双方都确认了自己能发送到对方，对方也能接收到自己，从而双方都确认了信道的双向畅通。

参考<https://www.zhihu.com/question/24853633/answer/63668444>：
```
在谢希仁著《计算机网络》第四版中讲“三次握手”的目的是“为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误”。在另一部经典的《计算机网络》一书中讲“三次握手”的目的是为了解决“网络中存在延迟的重复分组”的问题。这两种不同的表述其实阐明的是同一个问题。
谢希仁版《计算机网络》中的例子是这样的，“已失效的连接请求报文段”的产生在这样一种情况下：client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。假设不采用“三次握手”，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这样，server的很多资源就白白浪费掉了。采用“三次握手”的办法可以防止上述现象发生。例如刚才那种情况，client不会向server的确认发出确认。server由于收不到确认，就知道client并没有要求建立连接。”
```
这个例子情景有点极端，不过意思主要还是说如果是两次握手，接收到第一个syn包并ack后就应该为连接分配缓存(可以推迟，但是那样实际上好像又变成三次握手了)。两次握手不适合应对这种“旧时代的连接请求报文段”的情况(虽然最后服务器收不到对方心跳也会断开连接)。

此外在第二个包时服务器就为连接分配资源也使得服务器易于受到syn洪泛攻击。按《计算机网络自顶向下方法》(ISBN 9787111599715) P169，SYN cookie被部署在大多数主流操作系统中，那么实际的操作系统实现，分配资源就是在收到第三个syn包后。SYN cookie能有效，说明实际的syn洪泛攻击，攻击者只能发第一个syn包，不会完成整个三次握手。参考<https://www.cloudflare.com/zh-cn/learning/ddos/syn-flood-ddos-attack/>: "攻击者通常使用伪造的IP地址向目标服务器发送大量SYN数据包"。也就是说，攻击者能往网络里发数据，但是IP并不是攻击者的，服务器的响应不会到攻击者那里，攻击者也就无法知道服务器的初始序列号，也就是说，由于随机初始序列号的存在，攻击者无法通过一并往网络中发送建立连接第一和第三个包的方式完成三次握手。(SYN cookie主要是在于如何选择出初始序列号)

选择随机的初始序列号(而不固定从0开始)，除了防攻击，应该也有防止“旧时代的连接请求报文段”的作用。

不过我感觉TCP设计的时候应该主要还是考虑的双方要确认对方信道畅通，所以设计成3次。

## 关闭连接
关闭连接有四次握手应该是因为TCP有半关闭状态。一次FIN与FIN的ACK之后，应该是FIN的发送方会关闭自己的输出缓冲，另一方关闭自己的输入缓冲。

调shutdown(fd, SHUT_WR)应该是会发FIN包给对面。(shutdown(fd, SHUT_WR)之后再write()，VSCode运行会提示: Exception has occurred.Broken pipe，ubuntu终端运行直接退出)

调shutdown(fd, SHUT_RD)应该是会关闭套接字的输入缓冲，操作系统仍会ACK对面，但用户进程不再能通过read()读取数据。(shutdown(fd, SHUT_RD)之后再read()，直接返回0)。

套接字应该可以当做由操作系统维护的逻辑设备，通过系统调用向用户进程暴露接口，可以多进程共享。具体来说，套接字是操作系统资源，但是多个进程可以通过文件描述符共同引用一个套接字。调用close(fd)后套接字的引用计数减一，到0后连接被关闭(对于TCP套接字)，套接字被摧毁。但是shutdown()不考虑引用计数，直接执行指定方向的关闭。

shutdown()不会摧毁套接字，只会关闭指定方向上的连接，还是需要通过调close()摧毁套接字(或者进程退出时由操作系统自动回收资源)。

[这个链接](https://juejin.cn/post/7041167124785528840)关于shutdown()和close()函数和我想的是一样的，内容更详细，《TCP/IP网络编程》(ISBN 9787115358851)和shutdown()、close()的linux manpage没描述这些细节，找了下《UNIX网络编程》有说这些细节。